<c-card class="w-100 mb-4">
  <c-card-header class="d-flex gap-2 align-items-center">
    <div class="row g-2 align-items-end">
      <!-- Buscar -->
      <div class="col-12 col-md-3">
        <input cFormControl class="form-control" [(ngModel)]="search" (keyup.enter)="onSearch()"
          placeholder="Buscar (código)">
      </div>

      <!-- Fecha inicial -->
      <div class="col-12 col-md-2">
        <label class="form-label">Fecha inicial</label>
        <input type="date" class="form-control" [(ngModel)]="dateFilter.start" (change)="onDateFilter()">
      </div>

      <!-- Fecha final -->
      <div class="col-12 col-md-2">
        <label class="form-label">Fecha final</label>
        <input type="date" class="form-control" [(ngModel)]="dateFilter.end" (change)="onDateFilter()">
      </div>

      <!-- Botones -->
      <div class="col-12 col-md-3 d-flex gap-2">
        <button class="btn btn-outline-danger flex-fill" (click)="clearDateFilter()">Limpiar</button>
        <button cButton color="secondary" class="flex-fill" (click)="onSearch()">Buscar</button>
      </div>

      <!-- Nuevo -->
      <div class="col-12 col-md-2 text-md-end">
        <button cButton color="primary" (click)="openCreate()">Nuevo</button>
      </div>
    </div>
  </c-card-header>

  <c-card-body class="p-0">
    <div class="table-responsive">
      <table class="table table-striped table-hover mb-0 table-sticky">
        <thead>
          <tr>
            <th>Código</th>
            <th>N° CIS</th>
            <th>Puerto Salida</th>
            <th>País Destino</th>
            <th>Procedencia</th>
            <th>Fecha Creación</th>
            <th style="width:160px">Acciones</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let r of rows">
            <td>{{ r.codigo || 'N/A' }}</td>
            <td>{{ r.Numero_Cis || 'N/A' }}</td>
            <td>{{ r.puerto_salida || 'N/A' }}</td>
            <td>{{ r.pais_destino || 'N/A' }}</td>
            <td>{{ r.procedencia || 'N/A' }}</td>
            <td>{{ r.created_at | date:'shortDate' }}</td>
            <td class="sticky-col">
              <div class="btn-group btn-group-sm">
                <!-- Editar - Lápiz moderno -->
                <button class="btn btn-outline-primary" (click)="openEdit(r)" title="Editar certificado">
                  <i class="bi bi-pencil-square"></i>
                  <!-- Alternativas: -->
                  <!-- bi bi-pencil-fill / bi bi-pencil / fas fa-edit -->
                </button>
                <!-- Eliminar - Papelera moderna -->
                <button class="btn btn-outline-danger" (click)="confirmDelete(r, $event)" title="Eliminar certificado">
                  <i class="bi bi-trash3-fill"></i>
                  <!-- Alternativas: -->
                  <!-- bi bi-trash / bi bi-trash-fill / fas fa-trash-alt -->
                </button>
              </div>
            </td>
          </tr>
          <tr *ngIf="!rows.length && !loading">
            <td colspan="6" class="text-center py-4 text-body-secondary">
              Sin resultados
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- <div class="p-3 d-flex justify-content-center" *ngIf="pages > 1">
      <c-pagination aria-label="Paginación" [activePage]="page" [pages]="pages" (activePageChange)="onPage($event)">
      </c-pagination>
    </div> -->

    <!-- Paginación simple Bootstrap -->
    <!-- <nav class="p-3 d-flex justify-content-center" *ngIf="pages > 1">
      <ul class="pagination mb-0">
        <li class="page-item" [class.disabled]="page <= 1">
          <button class="page-link" (click)="onPage(page - 1)" [disabled]="page <= 1">Anterior</button>
        </li>

        <li class="page-item" *ngFor="let p of pageNumbers()" [class.active]="p === page">
          <button class="page-link" (click)="onPage(p)">{{ p }}</button>
        </li>

        <li class="page-item" [class.disabled]="page >= pages">
          <button class="page-link" (click)="onPage(page + 1)" [disabled]="page >= pages">Siguiente</button>
        </li>
      </ul>
    </nav> -->
    <nav class="p-3 d-flex justify-content-center" *ngIf="pages > 1">
      <ul class="pagination mb-0">
        <li class="page-item" [class.disabled]="page <= 1">
          <button class="page-link" (click)="onPage(page - 1)" [disabled]="page <= 1">Anterior</button>
        </li>

        <li class="page-item" *ngFor="let p of pageItems()" [class.active]="p === page" [class.disabled]="p === '…'">
          <span class="page-link" *ngIf="p === '…'">…</span>
          <button class="page-link" *ngIf="p !== '…'" (click)="onPage(+p)">
            {{ p }}
          </button>
        </li>

        <li class="page-item" [class.disabled]="page >= pages">
          <button class="page-link" (click)="onPage(page + 1)" [disabled]="page >= pages">Siguiente</button>
        </li>
      </ul>
    </nav>

  </c-card-body>
</c-card>

<c-modal [visible]="showModal" (visibleChange)="onModalVisibleChange($event)" alignment="center" size="xl"
  [scrollable]="true">
  <c-modal-header>
    <h5 cModalTitle>{{ editing ? 'Editar certificado' : 'Nuevo certificado' }}</h5>
    <button cButtonClose (click)="showModal=false"></button>
  </c-modal-header>

  <c-modal-body>
    <!-- ====== CERTIFICADO ====== -->
    <div class="row g-3 mb-3">
      <div class="col-md-3"><label class="form-label">Código *</label><input cFormControl [(ngModel)]="form.codigo"
          required></div>
      <div class="col-md-3"><label class="form-label">CIS</label><input cFormControl [(ngModel)]="form.Numero_Cis">
      </div>
      <div class="col-md-3"><label class="form-label">Fecha precuarentena</label><input cFormControl type="date"
          [(ngModel)]="form.fecha_precuarentena"></div>
      <div class="col-md-3"><label class="form-label">Dictamen</label><input cFormControl [(ngModel)]="form.dictamen">
      </div>

      <div class="col-md-4"><label class="form-label">Puerto de salida</label><input cFormControl
          [(ngModel)]="form.puerto_salida"></div>
      <div class="col-md-4"><label class="form-label">País destino</label><input cFormControl
          [(ngModel)]="form.pais_destino"></div>
      <div class="col-md-4"><label class="form-label">Ruta de viaje</label><input cFormControl
          [(ngModel)]="form.ruta_viaje"></div>

      <div class="col-md-3"><label class="form-label">Procedencia</label><input cFormControl
          [(ngModel)]="form.procedencia"></div>
      <div class="col-md-3"><label class="form-label">Vía</label><input cFormControl [(ngModel)]="form.via"></div>

      <div class="col-md-6"><label class="form-label">Importador</label><input cFormControl
          [(ngModel)]="form.importador">
      </div>
      <div class="col-md-6"><label class="form-label">Dirección importador</label><input cFormControl
          [(ngModel)]="form.direccion_importador"></div>

      <div class="col-md-6"><label class="form-label">Exportador</label><input cFormControl
          [(ngModel)]="form.exportador">
      </div>
      <div class="col-md-6"><label class="form-label">Dirección exportador</label><input cFormControl
          [(ngModel)]="form.direccion_exportador"></div>

      <div class="col-md-4"><label class="form-label">Nombre predio</label><input cFormControl
          [(ngModel)]="form.nombre_predio"></div>
      <div class="col-md-4"><label class="form-label">Municipio</label><input cFormControl [(ngModel)]="form.municipio">
      </div>
      <div class="col-md-4"><label class="form-label">Vereda</label><input cFormControl [(ngModel)]="form.vereda"></div>

      <div class="col-12">
        <label class="form-label">Observaciones</label>
        <textarea cFormControl rows="3" [(ngModel)]="form.observaciones"></textarea>
      </div>
    </div>

    <!-- ====== CANINOS (productos) ====== -->
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h6 class="mb-0">Caninos</h6>
      <button cButton size="sm" color="secondary" (click)="addDog()">Agregar canino</button>
    </div>

    <div *ngFor="let d of form.productos; let i = index" class="border rounded p-3 mb-2">
      <div class="row g-2">
        <div class="col-12 col-md-2">
          <label class="form-label">Cantidad</label>
          <input cFormControl type="number" min="1" [(ngModel)]="d.cantidad">
        </div>

        <div class="col-12 col-md-2">
          <label class="form-label">Unidad</label>
          <select cSelect [(ngModel)]="d.unidad">
            <option>UNIDADES/UNITS</option>
            <option>OTRA</option>
          </select>
        </div>

        <div class="col-12 col-md-3">
          <label class="form-label">Producto</label>
          <input cFormControl [(ngModel)]="d.producto" placeholder="PERROS COMPAÑÍA">
        </div>

        <div class="col-12 col-md-3">
          <label class="form-label">Presentación</label>
          <input cFormControl [(ngModel)]="d.presentacion" placeholder="SOL / MERLA ...">
        </div>

        <div class="col-12 col-md-4">
          <label class="form-label">Code/Chip *</label>
          <input cFormControl [(ngModel)]="d.code_chip" required>
        </div>

        <div class="col-12 col-md-4">
          <label class="form-label">Raza</label>
          <input cFormControl [(ngModel)]="d.raza" placeholder="BULLDOG FRANCES">
        </div>

        <div class="col-12 col-md-4">
          <label class="form-label">Empaque</label>
          <select cSelect [(ngModel)]="d.empaque">
            <option>No Aplica</option>
            <option>GUACALES</option>
          </select>
        </div>

        <div class="col-12 col-md-3">
          <label class="form-label">Sexo</label>
          <select cSelect [(ngModel)]="d.sexo">
            <option value="Machos">Machos</option>
            <option value="Hembras">Hembras</option>
          </select>
        </div>

        <div class="col-12 col-md-3">
          <label class="form-label">Edad</label>
          <input cFormControl [(ngModel)]="d.edad" placeholder="4 MESES / 1 AÑO">
        </div>

        <div class="col-12 col-md-3">
          <label class="form-label">Valor FOB</label>
          <input cFormControl type="number" step="0.01" [(ngModel)]="d.valor_fob">
        </div>

        <div class="col-12 col-md-3 d-flex align-items-end justify-content-end">
          <button cButton color="danger" variant="outline" (click)="removeDog(i)">Quitar</button>
        </div>
      </div>
    </div>
  </c-modal-body>

  <c-modal-footer>
    <button cButton color="light" (click)="showModal=false">Cancelar</button>
    <button cButton color="primary" [disabled]="saving" (click)="save()">
      {{ saving ? 'Guardando...' : 'Guardar' }}
    </button>
  </c-modal-footer>
</c-modal>

<!-- Spinner de carga -->
<div class="position-fixed top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center"
  style="background:rgba(255,255,255,.35); z-index:1050" *ngIf="loading">
  <c-spinner></c-spinner>
</div>